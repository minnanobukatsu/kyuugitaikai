<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ã¿ã‚“ãªã®BUKATSUçƒæŠ€å¤§ä¼šé‹å–¶</title>
    <!-- ç”»åƒç”Ÿæˆç”¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        /* --- CSS Variables & Base Styles --- */
        :root {
            --primary: #32CD32; /* Lime Green */
            --primary-dark: #228B22;
            --accent: #FF8C00; /* Dark Orange */
            --bg-color: #f8f9fa;
            --text-color: #333;
            --border-color: #ddd;
            --white: #ffffff;
            --danger: #dc3545;
            --safe: #28a745;
            --line-color: #06C755; /* LINE Green */
            --event-bg: #e3f2fd; /* Light Blue for events */
        }

        * { box-sizing: border-box; touch-action: manipulation; }
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            padding-bottom: 70px; /* Space for bottom nav */
            overscroll-behavior-y: none; /* Prevent pull-to-refresh interfering with drag */
        }

        /* --- Layout & Typography --- */
        header {
            background: var(--primary);
            color: var(--white);
            padding: 1rem;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 { margin: 0; font-size: 1.2rem; font-weight: bold; }
        h2 { font-size: 1.1rem; border-left: 5px solid var(--accent); padding-left: 10px; margin-top: 20px; margin-bottom: 10px; }
        
        .container { padding: 15px; max-width: 800px; margin: 0 auto; }
        .hidden { display: none !important; }

        /* --- Controls --- */
        input, select, textarea, button {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 16px; /* Prevents iOS zoom */
        }
        
        /* Label Styles for Inputs */
        .input-label {
            font-size: 0.75rem;
            color: #666;
            display: block;
            margin-bottom: 4px;
            font-weight: bold;
        }

        button {
            background-color: var(--primary);
            color: white;
            border: none;
            font-weight: bold;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        button:active { opacity: 0.8; }
        button.accent { background-color: var(--accent); }
        button.danger { background-color: var(--danger); font-size: 0.8rem; width: auto; }
        button.secondary { background-color: #6c757d; }
        
        /* Share Button */
        button.share-btn {
            background-color: var(--line-color);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        /* --- Navigation --- */
        nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: var(--white);
            display: flex;
            justify-content: space-around;
            border-top: 1px solid var(--border-color);
            z-index: 1000;
            padding-bottom: env(safe-area-inset-bottom);
        }
        .nav-item {
            flex: 1;
            text-align: center;
            padding: 10px 0;
            font-size: 0.75rem;
            color: #888;
            cursor: pointer;
        }
        .nav-item.active {
            color: var(--primary-dark);
            font-weight: bold;
            border-top: 3px solid var(--primary);
        }
        .nav-icon { display: block; font-size: 1.2rem; margin-bottom: 4px; }

        /* --- Tab 1: Announcement --- */
        .preview-area {
            background: #fff;
            border: 1px solid var(--border-color);
            padding: 10px;
            min-height: 150px;
            white-space: pre-wrap;
            font-family: monospace;
            margin-bottom: 10px;
        }

        /* --- Tab 2: Teams --- */
        .team-editor { display: flex; flex-direction: column; gap: 15px; }
        .player-pool {
            background: #e9ecef;
            padding: 10px;
            border-radius: 8px;
            min-height: 80px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            transition: background-color 0.2s;
        }
        .team-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
        }
        .team-box {
            background: var(--white);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 10px;
            min-height: 100px;
            transition: background-color 0.2s;
        }
        .team-box h3 { 
            margin: 0 0 10px 0; 
            font-size: 1rem; 
            color: var(--primary-dark); 
            border-bottom: 1px solid #eee; 
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .edit-icon {
            font-size: 0.9rem;
            cursor: pointer;
            padding: 2px 6px;
            border-radius: 4px;
            background: #eee;
        }
        
        /* Drag & Drop Highlight */
        .drag-over {
            background-color: #d1e7dd !important; /* Light green highlight */
            border-color: var(--primary) !important;
            border-style: dashed !important;
        }

        /* Trash Area Style - Enlarged for easier drop */
        .trash-area {
            background: #fff0f0;
            border: 2px dashed var(--danger);
            color: var(--danger);
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            cursor: pointer;
            padding: 20px;
            min-height: 80px;
            margin-bottom: 10px;
            transition: all 0.2s;
            text-align: center;
        }
        .trash-area:active, .trash-area.drag-over {
            background: var(--danger);
            color: white;
            border-style: solid;
            transform: scale(1.02);
        }

        .player-chip {
            background: var(--white);
            border: 1px solid var(--primary);
            color: var(--primary-dark);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.95rem;
            cursor: grab;
            user-select: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            margin: 3px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .player-chip:active { cursor: grabbing; }
        
        .player-chip.selected {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
            transform: scale(1.05);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        /* Mobile Drag Avatar */
        .drag-avatar {
            position: fixed;
            pointer-events: none;
            z-index: 9999;
            opacity: 0.9;
            transform: scale(1.1);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            background: var(--primary);
            color: white;
            border: 2px solid white;
            width: auto;
            max-width: 200px;
            white-space: nowrap;
        }

        /* --- Tab 3: Match & Standings --- */
        .match-card {
            background: var(--white);
            border-left: 5px solid var(--border-color);
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            position: relative;
            cursor: pointer;
        }
        .match-card.finished { border-left-color: var(--primary); background: #f0fff4; }
        .match-card.active { border-left-color: var(--accent); }
        
        /* Event Card Style */
        .match-card.event-card {
            background: var(--event-bg);
            border-left: 5px solid #2196F3;
            cursor: default;
            padding: 8px 10px;
        }
        .match-card.event-card .event-title {
            font-weight: bold;
            font-size: 1rem;
            color: #0d47a1;
        }
        
        .match-info { font-size: 0.8rem; color: #666; margin-bottom: 5px; display: flex; justify-content: space-between; }
        .match-teams { display: flex; justify-content: space-between; align-items: center; font-size: 1.1rem; font-weight: bold; }
        .match-score { background: #eee; padding: 2px 8px; border-radius: 4px; min-width: 50px; text-align: center; }
        .match-ref { font-size: 0.8rem; color: var(--accent); margin-top: 5px; text-align: right; }
        
        table.standings { width: 100%; border-collapse: collapse; background: white; font-size: 0.9rem; }
        table.standings th, table.standings td { border: 1px solid #ddd; padding: 6px; text-align: center; }
        table.standings th { background: var(--primary); color: white; }

        /* --- Tab 4: Rules --- */
        .rule-content {
            background: white;
            padding: 15px;
            border-radius: 8px;
            min-height: 300px;
            white-space: pre-wrap;
            line-height: 1.6;
        }
        .rule-preset-btn { margin-bottom: 5px; font-size: 0.8rem; width: auto; display: inline-block; margin-right: 5px; }
        .emphasize-red { color: red; font-weight: bold; }
        
        /* Modal General */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 2000;
            display: flex; justify-content: center; align-items: center;
        }
        .modal-content {
            background: white; padding: 20px; border-radius: 8px; width: 90%; max-width: 400px;
            max-height: 90vh; overflow-y: auto;
        }
        .score-inputs { display: flex; gap: 10px; align-items: center; justify-content: center; margin: 20px 0; }
        .score-inputs input { text-align: center; font-size: 1.5rem; }

        /* Image Preview Modal */
        #generated-image-preview {
            width: 100%;
            height: auto;
            border: 1px solid #ccc;
            margin-bottom: 10px;
            display: block;
        }

    </style>
</head>
<body>

<header>
    <h1>ã¿ã‚“ãªã®BUKATSUçƒæŠ€å¤§ä¼šé‹å–¶</h1>
</header>

<main id="app">
    <!-- TAB 1: æ¡ˆå†…ä½œæˆ -->
    <section id="tab-announce" class="container">
        <h2>å‹Ÿé›†æ¡ˆå†…ä½œæˆ</h2>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
            <select id="ann-type">
                <option value="volley">ãƒãƒ¬ãƒ¼ãƒœãƒ¼ãƒ«</option>
                <option value="3x3">3x3 ãƒã‚¹ã‚±</option>
            </select>
            <input type="date" id="ann-date">
        </div>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
            <input type="time" id="ann-time-start" value="19:00">
            <input type="time" id="ann-time-end" value="21:00">
        </div>
        <input type="text" id="ann-place" placeholder="å ´æ‰€ï¼ˆä¾‹: ã€‡ã€‡å¸‚æ°‘ä½“è‚²é¤¨ï¼‰">
        <input type="text" id="ann-url" placeholder="ç”³ã—è¾¼ã¿ãƒ•ã‚©ãƒ¼ãƒ URL">
        <input type="text" id="ann-deadline" placeholder="ç· åˆ‡æ—¥ï¼ˆä¾‹: ã€‡/ã€‡ 24:00ã¾ã§ï¼‰">
        
        <button onclick="generateAnnouncement()">æ¡ˆå†…æ–‡ã‚’ç”Ÿæˆ</button>
        
        <textarea id="ann-result" class="preview-area" readonly></textarea>
        <button class="accent" onclick="copyAnnouncement()">ã‚³ãƒ”ãƒ¼ã™ã‚‹</button>
    </section>

    <!-- TAB 2: ãƒãƒ¼ãƒ ç·¨æˆ -->
    <section id="tab-teams" class="container hidden">
        <h2>ãƒãƒ¼ãƒ ç·¨æˆ</h2>
        <div style="margin-bottom: 10px; background: #fff; padding: 10px; border-radius: 8px;">
            <label style="font-size:0.8rem; font-weight:bold;">1. åç°¿ç™»éŒ²</label>
            <textarea id="name-input" rows="3" placeholder="åå‰ã‚’æ”¹è¡ŒåŒºåˆ‡ã‚Šã§è²¼ã‚Šä»˜ã‘"></textarea>
            <button class="secondary" onclick="loadNames()">åç°¿èª­ã¿è¾¼ã¿</button>
        </div>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <label style="font-size:0.8rem; font-weight:bold;">2. ãƒãƒ¼ãƒ åˆ†ã‘</label>
            <select id="team-count" style="width:auto; margin:0;" onchange="renderTeamBoxes()">
                <option value="3">3ãƒãƒ¼ãƒ </option>
                <option value="4" selected>4ãƒãƒ¼ãƒ </option>
                <option value="5">5ãƒãƒ¼ãƒ </option>
                <option value="6">6ãƒãƒ¼ãƒ </option>
                <option value="8">8ãƒãƒ¼ãƒ </option>
            </select>
        </div>
        <p style="font-size:0.8rem; color:#666; margin-top:-5px; margin-bottom:10px;">
            â€»ã‚¹ãƒãƒ›å¯¾å¿œï¼šæŒ‡ã§ãªãã£ã¦ç§»å‹•ã§ãã¾ã™<br>
            <span style="color:var(--danger); font-weight:bold;">â€»å‰Šé™¤ï¼šåå‰ã‚’ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ã€Œã‚´ãƒŸç®±ã€ã¸ãƒ‰ãƒ­ãƒƒãƒ—</span>
        </p>

        <div class="team-editor">
            <!-- æœªæ‰€å±ãƒ—ãƒ¼ãƒ« -->
            <div id="pool-area" class="player-pool drop-target" 
                 data-target="pool"
                 onclick="handleAreaClick('pool')"
                 ondragover="handleDragOver(event)"
                 ondragleave="handleDragLeave(event)"
                 ondrop="handleDrop(event, 'pool')">
                <span style="width:100%; font-size:0.7rem; color:#888; pointer-events:none;">æœªæ‰€å±ã‚¨ãƒªã‚¢</span>
                <!-- Players rendered here -->
            </div>

            <!-- ã‚´ãƒŸç®±ã‚¨ãƒªã‚¢ -->
            <div id="trash-area" class="trash-area drop-target"
                 data-target="trash"
                 onclick="handleAreaClick('trash')"
                 ondragover="handleDragOver(event)"
                 ondragleave="handleDragLeave(event)"
                 ondrop="handleDrop(event, 'trash')">
                 ğŸ—‘ï¸ ã“ã“ã«ç§»å‹•ã§å‰Šé™¤ (ã‚¿ãƒƒãƒ— or ãƒ‰ãƒ­ãƒƒãƒ—)
            </div>
            
            <!-- ãƒãƒ¼ãƒ BOX -->
            <div id="team-container" class="team-grid">
                <!-- Team boxes rendered here -->
            </div>
        </div>
        <button class="accent" style="margin-top:20px;" onclick="saveTeamsAndNotify()">ã“ã®ç·¨æˆã§æ±ºå®šï¼ˆè©¦åˆè¡¨ã¸é€£æºï¼‰</button>
    </section>

    <!-- TAB 3: è©¦åˆé€²è¡Œ -->
    <section id="tab-matches" class="container hidden">
        <h2>è©¦åˆé€²è¡Œ & çµæœ</h2>
        
        <div style="background:white; padding:10px; border-radius:8px; margin-bottom:15px; border:1px solid #ddd;">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:10px;">
                <div>
                    <label class="input-label">ç«¶æŠ€ãƒ¢ãƒ¼ãƒ‰</label>
                    <select id="match-mode" style="margin-bottom:0;">
                        <option value="volley">ãƒãƒ¬ãƒ¼ (1é¢)</option>
                        <option value="3x3">3x3 (2é¢)</option>
                    </select>
                </div>
                <div>
                    <label class="input-label">ç·å½“ãŸã‚Š</label>
                    <select id="match-rounds" style="margin-bottom:0;">
                        <option value="1">1å‘¨</option>
                        <option value="2">2å‘¨</option>
                    </select>
                </div>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:10px;">
                <div>
                    <label class="input-label" style="color:var(--primary-dark);">é›†åˆæ™‚é–“</label>
                    <input type="time" id="match-start-time" value="19:00" style="margin-bottom:0; font-weight:bold;">
                </div>
                <div>
                    <label class="input-label">è©¦åˆé–“éš” (åˆ†)</label>
                    <input type="number" id="match-interval" value="10" placeholder="åˆ†" style="margin-bottom:0;">
                </div>
            </div>
            <button class="secondary" style="margin:0;" onclick="generateSchedule()">æ—¥ç¨‹è¡¨ä½œæˆ</button>
        </div>

        <!-- è©¦åˆãƒªã‚¹ãƒˆç”»é¢ -->
        <div id="match-view-container">
            <!-- ç”»åƒå…±æœ‰ãƒœã‚¿ãƒ³ -->
            <button class="share-btn" onclick="shareAsImage('match-list')">
                <span style="font-size:1.2rem;">ğŸ“¤</span> ã“ã®è¡¨ã‚’ç”»åƒã§ä¿å­˜ãƒ»å…±æœ‰
            </button>

            <!-- è©¦åˆãƒªã‚¹ãƒˆ -->
            <div id="match-list"></div>

            <!-- é †ä½è¡¨ã¸ç§»å‹•ãƒœã‚¿ãƒ³ -->
            <button class="accent" style="margin-top:20px; padding:15px; font-size:1.1rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1);" onclick="showStandings()">
                ğŸ† è©¦åˆçµæœï¼ˆé †ä½è¡¨ï¼‰ã¸
            </button>
        </div>

        <!-- é †ä½è¡¨ç”»é¢ (åˆæœŸéè¡¨ç¤º) -->
        <div id="standings-view-container" class="hidden">
            <button class="secondary" style="margin-bottom:15px;" onclick="showMatchList()">ğŸ”™ è©¦åˆä¸€è¦§ã«æˆ»ã‚‹</button>
            
            <button class="share-btn" onclick="shareAsImage('standings-table')">
                <span style="font-size:1.2rem;">ğŸ“¤</span> é †ä½è¡¨ã‚’ç”»åƒã§ä¿å­˜ãƒ»å…±æœ‰
            </button>

            <table class="standings" id="standings-table">
                <thead>
                    <tr>
                        <th>é †ä½</th>
                        <th>ãƒãƒ¼ãƒ </th>
                        <th>å‹</th>
                        <th>å¾—å¤±ç‚¹</th>
                        <th>ç·å¾—</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        
        <div style="text-align:right; margin-top:40px;">
            <button class="danger" onclick="resetAllData()">ãƒ‡ãƒ¼ã‚¿å…¨æ¶ˆå»</button>
        </div>
    </section>

    <!-- TAB 4: ãƒ«ãƒ¼ãƒ« -->
    <section id="tab-rules" class="container hidden">
        <h2>å½“æ—¥ãƒ«ãƒ¼ãƒ«å‘¨çŸ¥</h2>
        <div class="rule-buttons">
            <button class="rule-preset-btn secondary" onclick="insertRule('strict')">å³å®ˆäº‹é …æŒ¿å…¥</button>
            <button class="rule-preset-btn secondary" onclick="insertRule('volley')">ãƒãƒ¬ãƒ¼ç”¨æŒ¿å…¥</button>
            <button class="rule-preset-btn secondary" onclick="insertRule('3x3')">3x3ç”¨æŒ¿å…¥</button>
        </div>
        <textarea id="rule-text" class="rule-content" placeholder="ã“ã“ã«ãƒ«ãƒ¼ãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚è‡ªå‹•ä¿å­˜ã•ã‚Œã¾ã™ã€‚" oninput="saveRules()"></textarea>
    </section>
</main>

<nav>
    <div class="nav-item active" onclick="switchTab('tab-announce', this)">
        <span class="nav-icon">ğŸ“¢</span>æ¡ˆå†…
    </div>
    <div class="nav-item" onclick="switchTab('tab-teams', this)">
        <span class="nav-icon">ğŸ‘¥</span>ãƒãƒ¼ãƒ 
    </div>
    <div class="nav-item" onclick="switchTab('tab-matches', this)">
        <span class="nav-icon">ğŸ†</span>è©¦åˆ
    </div>
    <div class="nav-item" onclick="switchTab('tab-rules', this)">
        <span class="nav-icon">ğŸ“œ</span>ãƒ«ãƒ¼ãƒ«
    </div>
</nav>

<!-- Score Modal -->
<div id="score-modal" class="modal-overlay hidden">
    <div class="modal-content">
        <h3 id="modal-title" style="text-align:center;">ã‚¹ã‚³ã‚¢å…¥åŠ›</h3>
        <div class="score-inputs">
            <div style="text-align:center;">
                <div id="modal-team-a-name" style="font-weight:bold; margin-bottom:5px;">A</div>
                <input type="number" id="score-a" inputmode="numeric">
            </div>
            <div style="font-weight:bold; font-size:1.5rem;">-</div>
            <div style="text-align:center;">
                <div id="modal-team-b-name" style="font-weight:bold; margin-bottom:5px;">B</div>
                <input type="number" id="score-b" inputmode="numeric">
            </div>
        </div>
        <div style="display:flex; gap:10px;">
            <button class="secondary" onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            <button class="primary" onclick="saveScore()">æ±ºå®š</button>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="delete-modal" class="modal-overlay hidden">
    <div class="modal-content" style="text-align:center;">
        <h3>âš ï¸ å‰Šé™¤ç¢ºèª</h3>
        <p>ã€Œ<span id="delete-target-name" style="font-weight:bold;"></span>ã€ã‚’<br>æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ</p>
        <div style="display:flex; gap:10px; justify-content:center; margin-top:20px;">
            <button class="secondary" onclick="closeDeleteModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            <button class="danger" onclick="executeDelete()">ã¯ã„ã€å‰Šé™¤ã—ã¾ã™</button>
        </div>
    </div>
</div>

<!-- Reset Confirmation Modal -->
<div id="reset-modal" class="modal-overlay hidden">
    <div class="modal-content" style="text-align:center;">
        <h3>âš ï¸ ãƒ‡ãƒ¼ã‚¿å…¨æ¶ˆå»</h3>
        <p>å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ<br><span style="color:var(--danger); font-weight:bold;">å¾©å…ƒã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚</span></p>
        <div style="display:flex; gap:10px; justify-content:center; margin-top:20px;">
            <button class="secondary" onclick="closeResetModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            <button class="danger" onclick="executeReset()">å…¨æ¶ˆå»ã™ã‚‹</button>
        </div>
    </div>
</div>

<!-- Team Name Edit Modal (NEW) -->
<div id="name-edit-modal" class="modal-overlay hidden">
    <div class="modal-content" style="text-align:center;">
        <h3>ãƒãƒ¼ãƒ åå¤‰æ›´</h3>
        <input type="text" id="edit-team-name-input" style="font-size:1.2rem; text-align:center;">
        <div style="display:flex; gap:10px; justify-content:center; margin-top:20px;">
            <button class="secondary" onclick="closeNameEditModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            <button class="primary" onclick="saveTeamName()">å¤‰æ›´ã™ã‚‹</button>
        </div>
    </div>
</div>

<!-- Image Share Modal -->
<div id="image-modal" class="modal-overlay hidden">
    <div class="modal-content" style="text-align:center; max-width:90%;">
        <h3>ğŸ“¤ ç”»åƒä¿å­˜ãƒ»å…±æœ‰</h3>
        <p style="font-size:0.9rem; color:#666; margin-bottom:10px;">
            ä¸‹ã®ç”»åƒã‚’<span style="color:var(--primary-dark); font-weight:bold;">é•·æŠ¼ã—</span>ã—ã¦ä¿å­˜ã™ã‚‹ã‹ã€<br>å…±æœ‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰LINEç­‰ã¸é€ã£ã¦ãã ã•ã„ã€‚
        </p>
        <div id="image-preview-container" style="margin-bottom:15px; border:1px solid #eee; padding:5px; max-height:50vh; overflow:auto;">
            <!-- Generated Image will be inserted here -->
        </div>
        <div style="display:flex; gap:10px; justify-content:center;">
            <button class="primary" onclick="closeImageModal()">é–‰ã˜ã‚‹</button>
        </div>
    </div>
</div>

<script>
    // --- State Management ---
    const APP_KEY = 'bukatsu_app_v1';
    let state = {
        teams: {}, // { teamId: [playerName, ...] }
        pool: [],  // [playerName, ...]
        matches: [], // [{id, time, t1, t2, s1, s2, court, ref, type, label}]
        rules: '',
        activeTab: 'tab-announce',
        matchMode: 'volley',
        teamNames: {} // { "Team1": "ãƒãƒ¼ãƒ A", ... }
    };

    let selectedPlayer = null; // For moving players (Tap logic)
    let currentMatchId = null; // For modal

    // --- Mobile Drag & Drop Variables ---
    let dragAvatar = null;
    let touchDragSource = null; // { name, from, index }
    let currentDropTarget = null;
    let touchStartX = 0;
    let touchStartY = 0;
    let isTouchDragging = false;
    
    // --- Delete Modal Variables ---
    let pendingDelete = null; // { name, from, index }

    // --- Team Name Edit Variables ---
    let editingTeamKey = null;

    // --- Initialization ---
    window.addEventListener('load', () => {
        loadData();
        renderTeamBoxes();
        renderPlayers();
        renderMatches();
        document.getElementById('rule-text').value = state.rules;
        
        // Tab Restoration
        if(state.activeTab) {
            const el = document.querySelector(`[onclick="switchTab('${state.activeTab}', this)"]`);
            if(el) switchTab(state.activeTab, el);
        }
    });

    function saveData() {
        localStorage.setItem(APP_KEY, JSON.stringify(state));
    }

    function loadData() {
        const stored = localStorage.getItem(APP_KEY);
        if (stored) {
            state = JSON.parse(stored);
            // Ensure teamNames exists
            if (!state.teamNames) state.teamNames = {};
        } else {
            // Default Rules
            state.rules = "ã€å³å®ˆäº‹é …ã€‘\nãƒ»å¯©åˆ¤ã¸ã®æ–‡å¥ã¯å³é€€å ´ï¼\nãƒ»ã‚¢ã‚¯ã‚»ãƒ»ã‚¬ãƒ ç¦æ­¢ï¼ˆç™ºè¦‹æ¬¡ç¬¬å³é€€å ´ï¼‰\nãƒ»ã‚´ãƒŸã¯æŒã¡å¸°ã‚‹ã“ã¨\n\nã€ãƒ«ãƒ¼ãƒ«ã€‘\næ€ªæˆ‘ã®ãªã„ã‚ˆã†ã«æ¥½ã—ãã‚„ã‚Šã¾ã—ã‚‡ã†ã€‚";
        }
    }

    // --- Helper: Get Display Name ---
    function getTeamName(key) {
        return state.teamNames[key] || key;
    }

    // --- Reset Data Logic ---
    function resetAllData() {
        document.getElementById('reset-modal').classList.remove('hidden');
    }

    function closeResetModal() {
        document.getElementById('reset-modal').classList.add('hidden');
    }

    function executeReset() {
        localStorage.removeItem(APP_KEY);
        location.reload();
    }

    // --- Team Name Edit Logic ---
    function openNameEditModal(teamKey) {
        editingTeamKey = teamKey;
        const currentName = state.teamNames[teamKey] || teamKey;
        document.getElementById('edit-team-name-input').value = currentName;
        document.getElementById('name-edit-modal').classList.remove('hidden');
        // Auto focus
        setTimeout(() => document.getElementById('edit-team-name-input').focus(), 100);
    }

    function closeNameEditModal() {
        document.getElementById('name-edit-modal').classList.add('hidden');
        editingTeamKey = null;
    }

    function saveTeamName() {
        if (!editingTeamKey) return;
        
        const newName = document.getElementById('edit-team-name-input').value.trim();
        if (newName) {
            state.teamNames[editingTeamKey] = newName;
            saveData();
            renderTeamBoxes();
            // Also refresh other views just in case
            renderMatches(); 
            renderStandings();
        }
        closeNameEditModal();
    }

    // --- View Switching Logic (Matches <-> Standings) ---
    function showStandings() {
        document.getElementById('match-view-container').classList.add('hidden');
        document.getElementById('standings-view-container').classList.remove('hidden');
        renderStandings();
        window.scrollTo(0, 0); // Scroll to top
    }

    function showMatchList() {
        document.getElementById('standings-view-container').classList.add('hidden');
        document.getElementById('match-view-container').classList.remove('hidden');
        window.scrollTo(0, 0);
    }

    // --- Share as Image Logic (Simplified) ---
    async function shareAsImage(targetId) {
        const targetElement = document.getElementById(targetId);

        if (!targetElement || (targetElement.innerHTML.trim() === "" && state.matches.length === 0)) {
            alert("ä¿å­˜ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
            return;
        }

        const btns = document.querySelectorAll('.share-btn');
        // Loading indication
        btns.forEach(b => b.innerHTML = 'â³ ç”Ÿæˆä¸­...');

        try {
            const canvas = await html2canvas(targetElement, {
                backgroundColor: "#ffffff",
                scale: 2 // High resolution
            });

            const imgData = canvas.toDataURL("image/png");
            
            // Show Modal with Image
            const img = document.createElement('img');
            img.src = imgData;
            img.id = 'generated-image-preview';
            
            const container = document.getElementById('image-preview-container');
            container.innerHTML = ''; // Clear previous
            container.appendChild(img);
            
            document.getElementById('image-modal').classList.remove('hidden');

        } catch (e) {
            alert('ç”»åƒç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            console.error(e);
        } finally {
            // Restore buttons
            btns.forEach(b => b.innerHTML = '<span style="font-size:1.2rem;">ğŸ“¤</span> ç”»åƒã§ä¿å­˜ãƒ»å…±æœ‰');
        }
    }

    function closeImageModal() {
        document.getElementById('image-modal').classList.add('hidden');
    }

    // --- Tab Navigation ---
    window.switchTab = (tabId, navEl) => {
        document.querySelectorAll('section').forEach(el => el.classList.add('hidden'));
        document.getElementById(tabId).classList.remove('hidden');
        
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        if(navEl) navEl.classList.add('active');

        state.activeTab = tabId;
        saveData();
    };

    // --- TAB 1: Announcement ---
    window.generateAnnouncement = () => {
        const type = document.getElementById('ann-type').value;
        const dateVal = document.getElementById('ann-date').value; // YYYY-MM-DD
        const start = document.getElementById('ann-time-start').value;
        const end = document.getElementById('ann-time-end').value;
        const place = document.getElementById('ann-place').value;
        const url = document.getElementById('ann-url').value;
        const deadline = document.getElementById('ann-deadline').value;

        // Date formatting
        let dateStr = 'æœªå®š';
        let deadlineDateStr = deadline || 'å®šå“¡ã¾ã§';

        if(dateVal) {
            const d = new Date(dateVal);
            const y = d.getFullYear();
            const m = d.getMonth() + 1;
            const dt = d.getDate();
            const day = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'][d.getDay()];
            dateStr = `${y}å¹´${m}æœˆ${dt}æ—¥(${day})`;
        }

        let text = '';
        if (type === 'volley') {
            text = `ï¼œã¿ã‚“ãªã®çƒæŠ€å¤§ä¼šğŸã€ãƒãƒ¬ãƒ¼ã€‘ï¼

ã€ã¿ã‚“ãªã®BUKATSUğŸ€ã€ãŒä¸»å‚¬ã™ã‚‹ã€ãƒãƒ¬ãƒ¼ãƒœãƒ¼ãƒ«å¤§ä¼šã§ã™â€¼ï¸
ãƒãƒ¬ãƒ¼å¥½ãğŸã¯ã‚‚ã¡ã‚ã‚“ã€ã‚¹ãƒãƒ¼ãƒ„ã‚’é€šã˜ã¦å‹é”ã‚’ä½œã‚ŠãŸã„æ–¹ã€ä¹…ã€…ã«èº«ä½“ã‚’å‹•ã‹ã—ãŸã„æ–¹ã€ã¿ã‚“ãªã§ãƒ¯ã‚¤ãƒ¯ã‚¤æ¥½ã—ã¿ãŸã„æ–¹ã®ã”å‚åŠ ã‚’ãŠå¾…ã¡ã—ã¦ã„ã¾ã™ï¼

ã€ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ã“ã‚“ãªæ–¹ã‚ªã‚¹ã‚¹ãƒ¡ğŸ€ã€‘
â—‹ä¹…ã€…ã«ãƒãƒ¬ãƒ¼ãŒã—ãŸã„æ–¹
â—‹åˆå¿ƒè€…ãƒ»æœªçµŒé¨“ã ã‘ã©æŒ‘æˆ¦ã—ã¦ã¿ãŸã„æ–¹
â—‹ã‚¹ãƒãƒ¼ãƒ„ã‚’é€šã˜ã¦å‹é”ã‚’ä½œã‚ŠãŸã„æ–¹
â—‹ã¿ã‚“ãªã§ãƒ¯ã‚¤ãƒ¯ã‚¤æ¥½ã—ã¿ãŸã„æ–¹

â– æ—¥æ™‚
${dateStr}
${start} ï½ ${end}

â– å ´æ‰€
${place || 'æœªå®š'}

â– å‚åŠ è²»
ãƒ»ä¼šå“¡: 2,000å††/äºº
ãƒ»éä¼šå“¡: 3,000å††/äºº
ï¼ˆå†…è¨³ï¼šå¤§ä¼šå‚åŠ è²»2,000å††ï¼‹ä½“é¨“å‚åŠ è²»1,000å††ï¼‰

â– å¤§ä¼šå½¢å¼ãƒ»æ™¯å“
â€»å½“æ—¥é‹å–¶ã«ã¦ãƒãƒ¼ãƒ åˆ†ã‘ã‚’è¡Œã„ã¾ã™ï¼ˆå€‹äººå‚åŠ ãƒ¡ã‚¤ãƒ³ã§ã™ï¼‰
â€»ãƒ•ã‚©ãƒ¼ãƒ å†…ã§å‚åŠ ãƒ¬ãƒ™ãƒ«ï¼ˆåˆå¿ƒè€…ã€œçµŒé¨“è€…ã¾ã§ï¼‰ã‚’é¸æŠã„ãŸã ãã¾ã™ã€‚ãƒãƒ¼ãƒ åˆ†ã‘ã®å‚è€ƒã«ã—ã¾ã™ã®ã§ã€ã”å”åŠ›ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚
â€»å‚åŠ è³ã‚ã‚Šï¼
â€»å„ªå‹ãƒãƒ¼ãƒ ã«ã¯3,500å††ç›¸å½“ã®MB Tã‚·ãƒ£ãƒ„ã‚’äººæ•°åˆ†ãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆï¼

ã€å‚åŠ ç”³è¾¼ãƒ•ã‚©ãƒ¼ãƒ ã€‘
${url || 'URLæœªå®š'}

â€»ç· åˆ‡ï¼š${deadlineDateStr}

---

ã€åŸºæœ¬ãƒ«ãƒ¼ãƒ«ã€‘
https://youtu.be/Lv2k2y2W6Yg?si=95TuErFchL2QpeCf
â€»ç´°ã‹ã„ãƒ«ãƒ¼ãƒ«ã«é–¢ã—ã¦ã¯ã€ã¿ã‚“ãªã®ãƒãƒ¬ãƒ¼é€šå¸¸é–‹å‚¬ã«æ²¿ã£ã¦è¡Œã„ã¾ã™ã€‚

ã€ãƒ­ãƒ¼ã‚«ãƒ«ãƒ«ãƒ¼ãƒ«ã€‘
ï¼œï¼‘å‘¨ç›®ï¼
ãƒ»å¿…ãš3å›è§¦ã£ã¦ã‹ã‚‰ç›¸æ‰‹ã«è¿”ã™
ãƒ»ã‚»ãƒƒã‚¿ãƒ¼å›ºå®šã‚ã‚Š
ãƒ»ãƒãƒ¼ãƒ å†…ã®ãƒ¬ãƒ™ãƒ«ï¼”ã¾ã§ã®èª°ã‹ï¼‘äººå¾—ç‚¹2å€

ï¼œï¼’å‘¨ç›®ï¼
ãƒ»ã‚»ãƒƒã‚¿ãƒ¼å›ºå®šãªã—
ãƒ»å¿…ãšãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³

ï¼œï¼‘å‘¨ã€ï¼’å‘¨å…±é€šï¼
ãƒ»ãƒãƒ¼ãƒ ç·å½“ãŸã‚Š(2å‘¨)
ãƒ»äº¤ä»£ã¯ã„ã¤ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ã‚‚OK
ãƒ»21ç‚¹ãƒãƒƒãƒ(ãƒ‡ãƒ¥ãƒ¼ã‚¹ãªã—)
ãƒ»å‚åŠ ãƒãƒ¼ãƒ æ•°ã«ã‚ˆã£ã¦ãƒ‡ãƒ¥ãƒ¼ã‚¹ã‚ã‚Š
ãƒ»ä¼‘æ†©ãƒãƒ¼ãƒ ã‹ã‚‰å¯©åˆ¤ã€ç·šå¯©ã€å¾—ç‚¹æ¿
ãƒ»é †ä½ã¯å‹ã¡ã®å¤šã„ãƒãƒ¼ãƒ ã‹ã‚‰æ±ºå®šã—ã€
ã€€åŒç€ã®å ´åˆå¾—å¤±ç‚¹å·®ã«ã¦æ±ºå®šã¨ã™ã‚‹ã€‚

ã€é‡è¦ï¼šå³å®ˆäº‹é …ã€‘
ãƒ»å¯©åˆ¤ã¸ã®æ–‡å¥ã¯ã€å³é€€å ´ï¼
ãƒ»ã‚¢ã‚¯ã‚»ã‚µãƒªãƒ¼ã‚„ã€ã‚¬ãƒ ã‚’å™›ã¿ãªãŒã‚‰ã®
ã€€ãƒ—ãƒ¬ãƒ¼ã¯ç¦æ­¢ã¨ã—ã¾ã™ã€‚
ã€€â€»ç™ºè¦‹ã—ãŸéš›ã¯ã€å³é€€å ´

â€»ãƒ«ãƒ¼ãƒ«ã¯äº‹å‰ã«ç¢ºèªãŠé¡˜ã„è‡´ã—ã¾ã™ã€‚`;
        } else if (type === '3x3') {
             text = `ï¼œã¿ã‚“ãªã®çƒæŠ€å¤§ä¼šğŸ€ã€3Ã—3ã€‘ï¼

ã€ã¿ã‚“ãªã®BUKATSUğŸ€ã€ãŒä¸»å‚¬ã™ã‚‹ã€3x3ãƒã‚¹ã‚±ãƒƒãƒˆãƒœãƒ¼ãƒ«å¤§ä¼šã§ã™â€¼ï¸
ãƒã‚¹ã‚±å¥½ãğŸ€ã¯ã‚‚ã¡ã‚ã‚“ã€ãƒãƒ¼ãƒ ã§è…•è©¦ã—ã—ãŸã„æ–¹ã€å€‹äººã§æ°—è»½ã«å‚åŠ ã—ãŸã„æ–¹ã€ã¿ã‚“ãªã§ãƒ¯ã‚¤ãƒ¯ã‚¤æ¥½ã—ã¿ãŸã„æ–¹ã®ã”å‚åŠ ã‚’ãŠå¾…ã¡ã—ã¦ã„ã¾ã™ï¼

ã€ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ã“ã‚“ãªæ–¹ã‚ªã‚¹ã‚¹ãƒ¡ğŸ€ã€‘
â—‹3x3ãŒå¥½ããªæ–¹
â—‹ãƒãƒ¼ãƒ ã§å¤§ä¼šã«å‡ºã¦ã¿ãŸã„æ–¹
â—‹å€‹äººã ã‘ã©ã‚²ãƒ¼ãƒ ï¼ˆè©¦åˆï¼‰ãŒã—ãŸã„æ–¹
â—‹ã‚¹ãƒãƒ¼ãƒ„ã‚’é€šã˜ã¦å‹é”ã‚’ä½œã‚ŠãŸã„æ–¹
â—‹ãƒã‚¹ã‚±ä»²é–“ãŒã»ã—ã„æ–¹

â– æ—¥æ™‚
${dateStr}
${start} ï½ ${end}

â– å ´æ‰€
${place || 'æœªå®š'}

â– å‚åŠ è²»
ãƒ»ä¼šå“¡: 2,000å††/äºº
ãƒ»éä¼šå“¡: 3,000å††/äºº
ï¼ˆå†…è¨³ï¼šå¤§ä¼šå‚åŠ è²»2,000å††ï¼‹ä½“é¨“å‚åŠ è²»1,000å††ï¼‰
â€»å‚åŠ è²»ã¯å½“æ—¥ã€ãŠä¸€äººæ§˜ãšã¤ï¼ˆã¾ãŸã¯ãƒãƒ¼ãƒ ä»£è¡¨è€…ãŒã¾ã¨ã‚ã¦ï¼‰ãŠæ”¯æ‰•ã„ãã ã•ã„ã€‚

â– å¤§ä¼šå½¢å¼ãƒ»æ™¯å“
â€»ã€ãƒãƒ¼ãƒ å‚åŠ ã€‘ã¾ãŸã¯ã€å€‹äººå‚åŠ ã€‘ã‚’é¸æŠã§ãã¾ã™ã€‚
â€»ãƒãƒ¼ãƒ å‚åŠ ã®å ´åˆã€å…ˆç€ï¼”ãƒãƒ¼ãƒ ã¾ã§ã¨ã—ã¾ã™ã€‚
â€»ãƒãƒ¼ãƒ äººæ•°ã¯æœ€ä½3äººï¼ˆä¸Šé™ãªã—ï¼‰ã§ã™ã€‚
â€»å€‹äººå‚åŠ ã®å ´åˆã¯å½“æ—¥é‹å–¶ã«ã¦ãƒãƒ¼ãƒ åˆ†ã‘ã‚’è¡Œã„ã¾ã™ã€‚
â€»å‚åŠ è³ã‚ã‚Šï¼
â€»å„ªå‹ãƒãƒ¼ãƒ ã«ã¯3,500å††ç›¸å½“ã®MB Tã‚·ãƒ£ãƒ„ã‚’äººæ•°åˆ†ãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆï¼

ã€å‚åŠ ç”³è¾¼ãƒ•ã‚©ãƒ¼ãƒ ã€‘
${url || 'URLæœªå®š'}

â€»ç· åˆ‡ï¼š${deadlineDateStr}

---

ã€åŸºæœ¬ãƒ«ãƒ¼ãƒ«ã€‘
https://youtu.be/RgaQKbbY5QU?si=Q1FjNxEoivU790U8

ã€ãƒ­ãƒ¼ã‚«ãƒ«ãƒ«ãƒ¼ãƒ«ã€‘
â—6ãƒãƒ¼ãƒ ç·å½“ãŸã‚Šï¼ˆå‚åŠ ãƒãƒ¼ãƒ æ•°ã«ã‚ˆã‚Šå¤‰å‹•ã—ã¾ã™ï¼‰
â—7åˆ†ã¾ãŸã¯17ç‚¹å…ˆå–
â—ã‚¿ã‚¤ãƒãƒ¼ã¯å…¨ã¦æµã—
â—ãƒãƒ¼ãƒ ãƒ•ã‚¡ãƒ¼ãƒ«5ã¤ã‹ã‚‰ãƒ•ãƒªãƒ¼ã‚¹ãƒ­ãƒ¼
â—ç«æ›œã®çµŒé¨“è€…ãƒã‚¹ã‚±ã«å‚åŠ ã—ã¦ã„ãªã„ç”·æ€§ã¯å¾—ç‚¹2å€ã€å¥³æ€§ã¯3å€
â—é †ä½ã¯å‹ã¡ã®å¤šã„ãƒãƒ¼ãƒ ã‹ã‚‰æ±ºå®šã—ã€
ã€€åŒç€ã®å ´åˆå¾—å¤±ç‚¹å·®ã«ã¦æ±ºå®šã¨ã™ã‚‹ã€‚

ã€é‡è¦ï¼šå³å®ˆäº‹é …ã€‘
â—å¯©åˆ¤ã¸ã®æ–‡å¥ã¯ã€å³é€€å ´ï¼
â—ã‚¢ã‚¯ã‚»ã‚µãƒªãƒ¼ã‚„ã€ã‚¬ãƒ ã‚’å™›ã¿ãªãŒã‚‰ã®
ã€€ãƒ—ãƒ¬ãƒ¼ã¯ç¦æ­¢ã¨ã—ã¾ã™ã€‚
ã€€â€»ç™ºè¦‹ã—ãŸéš›ã¯ã€å³é€€å ´

â€»ãƒ«ãƒ¼ãƒ«ã¯äº‹å‰ã«ç¢ºèªãŠé¡˜ã„è‡´ã—ã¾ã™ã€‚`;
        }

        document.getElementById('ann-result').value = text;
    };

    window.copyAnnouncement = () => {
        const ta = document.getElementById('ann-result');
        ta.select();
        document.execCommand('copy');
        alert('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
    };

    // --- TAB 2: Team Building ---
    window.loadNames = () => {
        const input = document.getElementById('name-input').value;
        if(!input.trim()) return;
        
        const names = input.split(/\n/).map(n => n.trim()).filter(n => n);
        state.pool = [...state.pool, ...names];
        document.getElementById('name-input').value = '';
        saveData();
        renderPlayers();
    };

    // Render players in pool
    function renderPlayers() {
        const poolDiv = document.getElementById('pool-area');
        poolDiv.innerHTML = '<span style="width:100%; font-size:0.7rem; color:#888; pointer-events:none;">æœªæ‰€å±ã‚¨ãƒªã‚¢</span>';
        
        state.pool.forEach((p, idx) => {
            poolDiv.appendChild(createChip(p, 'pool', idx));
        });

        // Also refresh teams to ensure consistency
        const count = parseInt(document.getElementById('team-count').value);
        for(let i=1; i<=count; i++) {
            const box = document.getElementById(`team-box-${i}`);
            if(box) {
                // Keep header, clear content
                const header = box.querySelector('h3');
                box.innerHTML = ''; // Clear only content, keep container
                // Rebuild header
                if (header) {
                    box.appendChild(header);
                    
                    const teamKey = `Team${i}`;
                    // Update header text based on current name
                    // Toggle edit on header click (text or icon)
                    header.style.cursor = 'pointer'; // Make it look clickable
                    header.innerHTML = `<span>${getTeamName(teamKey)}</span> <span class="edit-icon">âœï¸</span>`;
                    
                    header.onclick = (e) => { 
                        e.stopPropagation(); // Prevent triggering team selection/move
                        openNameEditModal(teamKey);
                    };
                }

                // Add drop target attributes
                box.classList.add('drop-target');
                box.dataset.target = `Team${i}`; // fixed variable scope issue if any, but teamKey is defined above. Let's use teamKey.
                // Wait, teamKey is defined inside the loop.

                const teamKey = `Team${i}`; // Re-declaring or reusing? It was declared inside the if(box) block above.
                // Ah, in the original code:
                /*
                const teamKey = `Team${i}`;
                // ... uses h3 ...
                */
               // Let's stick to the structure.
                
                if(state.teams[teamKey]) {
                    state.teams[teamKey].forEach((p, idx) => {
                        box.appendChild(createChip(p, teamKey, idx));
                    });
                }
            }
        }
    }

    // Create Chip Element
    function createChip(name, location, index) {
        const span = document.createElement('span');
        span.className = 'player-chip';
        span.draggable = true; // Enable Drag (PC)
        
        if(selectedPlayer && selectedPlayer.name === name && selectedPlayer.from === location && selectedPlayer.idx === index) {
            span.classList.add('selected');
        }

        // Tap Selection Logic
        span.onclick = (e) => {
            e.stopPropagation();
            if(selectedPlayer && selectedPlayer.name === name && selectedPlayer.idx === index) {
                selectedPlayer = null; // Deselect
            } else {
                selectedPlayer = { name, from: location, idx: index };
            }
            renderPlayers();
        };

        // PC Drag Events
        span.ondragstart = (e) => handleDragStart(e, name, location, index);
        span.ondragend = handleDragEnd;

        // Mobile Touch Events
        span.ontouchstart = (e) => handleTouchStart(e, name, location, index);
        span.ontouchmove = handleTouchMove;
        span.ontouchend = handleTouchEnd;

        // Name Text
        const text = document.createElement('span');
        text.textContent = name;
        span.appendChild(text);

        return span;
    }

    // --- PC Drag and Drop Logic ---
    function handleDragStart(e, name, from, index) {
        e.dataTransfer.setData('text/plain', JSON.stringify({name, from, index}));
        e.dataTransfer.effectAllowed = 'move';
        e.target.style.opacity = '0.5';
    }

    function handleDragEnd(e) {
        e.target.style.opacity = '1';
        document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
    }

    function handleDragOver(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        e.currentTarget.classList.add('drag-over');
    }

    function handleDragLeave(e) {
        e.currentTarget.classList.remove('drag-over');
    }

    function handleDrop(e, targetArea) {
        e.preventDefault();
        e.currentTarget.classList.remove('drag-over');
        const data = e.dataTransfer.getData('text/plain');
        if(!data) return;
        
        try {
            const {name, from, index} = JSON.parse(data);
            movePlayer(name, from, targetArea, index);
        } catch(err) {
            console.error(err);
        }
    }

    // --- Mobile Touch Drag Logic (New) ---
    function handleTouchStart(e, name, from, index) {
        const touch = e.touches[0];
        touchStartX = touch.clientX;
        touchStartY = touch.clientY;
        touchDragSource = { name, from, index };
        isTouchDragging = false;
        // Do not preventDefault here to allow tap/click
    }

    function handleTouchMove(e) {
        const touch = e.touches[0];
        const dx = touch.clientX - touchStartX;
        const dy = touch.clientY - touchStartY;
        
        // Start dragging after small movement
        if (!isTouchDragging && (Math.abs(dx) > 5 || Math.abs(dy) > 5)) {
            isTouchDragging = true;
            // Create ghost avatar
            if(dragAvatar) document.body.removeChild(dragAvatar);
            dragAvatar = document.createElement('div');
            dragAvatar.className = 'player-chip drag-avatar';
            dragAvatar.innerText = touchDragSource.name;
            document.body.appendChild(dragAvatar);
        }

        if (isTouchDragging) {
            e.preventDefault(); // Prevent scrolling
            
            if(dragAvatar) {
                // Move avatar
                dragAvatar.style.left = `${touch.clientX - 20}px`;
                dragAvatar.style.top = `${touch.clientY - 20}px`;

                // Find drop target
                dragAvatar.style.display = 'none'; // Hide to check element below
                const elem = document.elementFromPoint(touch.clientX, touch.clientY);
                dragAvatar.style.display = 'block';

                if(elem) {
                    const targetEl = elem.closest('.drop-target');
                    // Remove old highlights
                    document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
                    
                    if(targetEl) {
                        targetEl.classList.add('drag-over');
                        currentDropTarget = targetEl;
                    } else {
                        currentDropTarget = null;
                    }
                }
            }
        }
    }

    function handleTouchEnd(e) {
        if (isTouchDragging) {
            e.preventDefault(); // Prevent click
            
            if(currentDropTarget) {
                const targetArea = currentDropTarget.dataset.target;
                if(targetArea) {
                    movePlayer(touchDragSource.name, touchDragSource.from, targetArea, touchDragSource.index);
                }
            }
            
            // Cleanup
            if(dragAvatar && dragAvatar.parentNode) {
                dragAvatar.parentNode.removeChild(dragAvatar);
            }
            document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
            dragAvatar = null;
            currentDropTarget = null;
        }
        isTouchDragging = false;
    }

    // --- Delete Modal Logic ---
    function confirmDelete(name, from, index) {
        pendingDelete = { name, from, index };
        document.getElementById('delete-target-name').textContent = name;
        document.getElementById('delete-modal').classList.remove('hidden');
    }

    function closeDeleteModal() {
        pendingDelete = null;
        document.getElementById('delete-modal').classList.add('hidden');
    }

    function executeDelete() {
        if (pendingDelete) {
            const { name, from, index } = pendingDelete;
            // Remove from source using INDEX
            if(from === 'pool') {
                state.pool.splice(index, 1);
            } else {
                if(state.teams[from]) {
                    state.teams[from].splice(index, 1);
                }
            }
            selectedPlayer = null;
            saveData();
            renderPlayers();
        }
        closeDeleteModal();
    }

    // Unified Move Logic
    function movePlayer(name, from, targetArea, index) {
        // Special case: Trash - Show Modal
        if (targetArea === 'trash') {
            confirmDelete(name, from, index);
            return;
        }

        if(from === targetArea) return; // No move needed

        // Remove from source using INDEX
        if(from === 'pool') {
            state.pool.splice(index, 1);
        } else {
            if(state.teams[from]) {
                state.teams[from].splice(index, 1);
            }
        }

        // Add to destination
        if(targetArea === 'pool') {
            state.pool.push(name);
        } else {
            if(!state.teams[targetArea]) state.teams[targetArea] = [];
            state.teams[targetArea].push(name);
        }

        selectedPlayer = null; // Clear selection if any
        saveData();
        renderPlayers();
    }

    window.renderTeamBoxes = () => {
        const container = document.getElementById('team-container');
        const count = parseInt(document.getElementById('team-count').value);
        container.innerHTML = '';

        for(let i=1; i<=count; i++) {
            const teamKey = `Team${i}`;
            const div = document.createElement('div');
            div.className = 'team-box drop-target';
            div.dataset.target = teamKey; // For mobile drag
            div.id = `team-box-${i}`;
            
            // Header with edit functionality
            const h3 = document.createElement('h3');
            h3.style.cursor = 'pointer'; // Make it look clickable
            
            // Initial render
            h3.innerHTML = `<span>${getTeamName(teamKey)}</span> <span class="edit-icon">âœï¸</span>`;
            
            // Toggle edit on header click (text or icon)
            h3.onclick = (e) => { 
                e.stopPropagation(); // Prevent triggering team selection/move
                openNameEditModal(teamKey);
            };

            div.appendChild(h3);
            
            // Tap Interaction
            div.onclick = () => handleAreaClick(teamKey);

            // Drag & Drop Interaction
            div.ondragover = (e) => handleDragOver(e);
            div.ondragleave = (e) => handleDragLeave(e);
            div.ondrop = (e) => handleDrop(e, teamKey);

            container.appendChild(div);
        }
        renderPlayers();
    };

    // Tap Area Logic
    window.handleAreaClick = (targetArea) => {
        if(!selectedPlayer) return;
        movePlayer(selectedPlayer.name, selectedPlayer.from, targetArea, selectedPlayer.idx);
    };

    window.saveTeamsAndNotify = () => {
        saveData();
        alert('ãƒãƒ¼ãƒ ç·¨æˆã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚\nã€Œè©¦åˆã€ã‚¿ãƒ–ã§æ—¥ç¨‹è¡¨ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚');
        // Switch to match tab
        const matchTabBtn = document.querySelectorAll('.nav-item')[2];
        switchTab('tab-matches', matchTabBtn);
    };


    // --- TAB 3: Match Schedule ---
    
    // Helper: Round Robin Generator
    function getRoundRobinPairs(teamKeys) {
        const pairs = [];
        const n = teamKeys.length;
        if (n < 2) return [];
        
        // Simple algorithm for all vs all
        for (let i = 0; i < n; i++) {
            for (let j = i + 1; j < n; j++) {
                pairs.push([teamKeys[i], teamKeys[j]]);
            }
        }
        return pairs.sort(() => Math.random() - 0.5);
    }

    window.generateSchedule = () => {
        const count = parseInt(document.getElementById('team-count').value);
        const mode = document.getElementById('match-mode').value;
        const startStr = document.getElementById('match-start-time').value;
        const interval = parseInt(document.getElementById('match-interval').value);
        const rounds = parseInt(document.getElementById('match-rounds').value) || 1;
        
        const teamKeys = [];
        for(let i=1; i<=count; i++) teamKeys.push(`Team${i}`);

        state.matches = [];
        state.matchMode = mode;

        let collectionTime = new Date(`2000-01-01T${startStr}:00`);

        // Helper to format time
        const formatTime = (date) => date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

        // 1. é›†åˆ (å…¥åŠ›ã•ã‚ŒãŸæ™‚é–“ãã®ã‚‚ã®)
        // Labelå¤‰æ›´: ä½“è‚²é¤¨é›†åˆãƒ»æº–å‚™ -> ä½“è‚²é¤¨é›†åˆã€æº–å‚™ã€ã‚¢ãƒƒãƒ—
        state.matches.push({ type: 'event', time: formatTime(collectionTime), label: 'ä½“è‚²é¤¨é›†åˆã€æº–å‚™ã€ã‚¢ãƒƒãƒ—', id: 'ev-1' });

        // 2. é–‹ä¼šå¼ (é›†åˆã‹ã‚‰30åˆ†å¾Œ)
        let openTime = new Date(collectionTime.getTime() + 30 * 60000);
        state.matches.push({ type: 'event', time: formatTime(openTime), label: 'é–‹ä¼šå¼ã€ãƒ«ãƒ¼ãƒ«èª¬æ˜', id: 'ev-2' });

        // ç¬¬1è©¦åˆé–‹å§‹ (é–‹ä¼šå¼ã‹ã‚‰10åˆ†å¾Œ => é›†åˆã‹ã‚‰40åˆ†å¾Œ)
        let currentTime = new Date(collectionTime.getTime() + 40 * 60000);

        // Generate Pairs
        let pairs = [];
        const loopCount = (mode === 'volley') ? rounds : 1; 

        for(let r=0; r<loopCount; r++) {
             let p = getRoundRobinPairs(teamKeys);
             if (r % 2 === 1) {
                 p = p.map(pair => [pair[1], pair[0]]);
             }
             pairs = pairs.concat(p);
        }
        
        // Scheduling Logic
        if(mode === 'volley') {
            // 1 Court: Sequential
            pairs.forEach((pair, idx) => {
                const timeStr = formatTime(currentTime);
                const playing = pair;
                const resting = teamKeys.filter(t => !playing.includes(t));
                const ref = resting.length > 0 ? resting[idx % resting.length] : 'ç›¸äº’';

                state.matches.push({
                    id: idx + 1,
                    time: timeStr,
                    t1: pair[0],
                    t2: pair[1],
                    s1: null,
                    s2: null,
                    court: 'Main',
                    ref: ref,
                    type: 'match'
                });
                
                currentTime.setMinutes(currentTime.getMinutes() + interval);
            });
        } else {
            // 3x3: 2 Courts Parallel
            const pairs3x3 = getRoundRobinPairs(teamKeys); 
            
            for(let i=0; i<pairs3x3.length; i+=2) {
                const timeStr = formatTime(currentTime);
                const pair1 = pairs3x3[i];
                const pair2 = pairs3x3[i+1] || null;

                const playing = [...pair1, ...(pair2 || [])];
                const resting = teamKeys.filter(t => !playing.includes(t));
                
                const ref1 = resting.length > 0 ? resting[0] : 'ç›¸äº’';
                
                state.matches.push({
                    id: i + 1,
                    time: timeStr,
                    t1: pair1[0],
                    t2: pair1[1],
                    s1: null, s2: null,
                    court: 'A',
                    ref: ref1,
                    type: 'match'
                });

                if(pair2) {
                    const ref2 = resting.length > 1 ? resting[1] : (resting.length > 0 ? resting[0] : 'ç›¸äº’');
                    state.matches.push({
                        id: i + 2,
                        time: timeStr,
                        t1: pair2[0],
                        t2: pair2[1],
                        s1: null, s2: null,
                        court: 'B',
                        ref: ref2,
                        type: 'match'
                    });
                }

                currentTime.setMinutes(currentTime.getMinutes() + interval);
            }
        }

        // Add Post-Event Items
        // 3. é–‰ä¼šå¼ (Immediately after last match)
        state.matches.push({ type: 'event', time: formatTime(currentTime), label: 'é–‰ä¼šå¼ã€çµæœç™ºè¡¨', id: 'ev-3' });

        // 4. ç‰‡ä»˜ã‘ (10 mins after)
        currentTime.setMinutes(currentTime.getMinutes() + 10);
        state.matches.push({ type: 'event', time: formatTime(currentTime), label: 'ç‰‡ä»˜ã‘', id: 'ev-4' });

        saveData();
        renderMatches();
        renderStandings();
        showMatchList(); 
    };

    window.renderMatches = () => {
        const list = document.getElementById('match-list');
        list.innerHTML = '';

        if(state.matches.length === 0) {
            list.innerHTML = '<div style="padding:20px; text-align:center; color:#999;">æ—¥ç¨‹è¡¨ãŒã‚ã‚Šã¾ã›ã‚“ã€‚<br>ä¸Šéƒ¨ãƒœã‚¿ãƒ³ã‹ã‚‰ä½œæˆã—ã¦ãã ã•ã„ã€‚</div>';
            return;
        }

        state.matches.forEach(m => {
            const div = document.createElement('div');
            
            if (m.type === 'event') {
                // Event Row
                div.className = 'match-card event-card';
                div.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span style="font-size:0.9rem; color:#555;">${m.time}</span>
                        <span class="event-title">${m.label}</span>
                    </div>
                `;
            } else {
                // Match Row
                const isFinished = m.s1 !== null && m.s2 !== null;
                div.className = `match-card ${isFinished ? 'finished' : ''}`;
                div.onclick = () => openScoreModal(m.id);

                div.innerHTML = `
                    <div class="match-info">
                        <span>No.${m.id} ${m.time}</span>
                        <span>ã‚³ãƒ¼ãƒˆ: ${m.court}</span>
                    </div>
                    <div class="match-teams">
                        <span>${getTeamName(m.t1)}</span>
                        <span class="match-score">${m.s1 !== null ? m.s1 : '-'} - ${m.s2 !== null ? m.s2 : '-'}</span>
                        <span>${getTeamName(m.t2)}</span>
                    </div>
                    <div class="match-ref">å¯©åˆ¤/TO: ${m.ref.startsWith('Team') ? getTeamName(m.ref) : m.ref}</div>
                `;
            }
            list.appendChild(div);
        });
    };

    // Score Modal
    window.openScoreModal = (matchId) => {
        const match = state.matches.find(m => m.id === matchId);
        // Ignore event rows
        if(!match || match.type === 'event') return;
        
        currentMatchId = matchId;
        document.getElementById('modal-title').innerText = `è©¦åˆ No.${match.id} çµæœå…¥åŠ›`;
        document.getElementById('modal-team-a-name').innerText = getTeamName(match.t1);
        document.getElementById('modal-team-b-name').innerText = getTeamName(match.t2);
        document.getElementById('score-a').value = match.s1;
        document.getElementById('score-b').value = match.s2;
        
        document.getElementById('score-modal').classList.remove('hidden');
    };

    window.closeModal = () => {
        document.getElementById('score-modal').classList.add('hidden');
        currentMatchId = null;
    };

    window.saveScore = () => {
        const s1 = document.getElementById('score-a').value;
        const s2 = document.getElementById('score-b').value;
        
        if(s1 === '' || s2 === '') {
            alert('ã‚¹ã‚³ã‚¢ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            return;
        }

        const match = state.matches.find(m => m.id === currentMatchId);
        match.s1 = parseInt(s1);
        match.s2 = parseInt(s2);
        
        saveData();
        renderMatches();
        renderStandings(); // Update standings immediately
        closeModal();
    };

    // Standings Logic
    window.renderStandings = () => {
        const tbody = document.querySelector('#standings-table tbody');
        tbody.innerHTML = '';
        
        // Init Stats
        const stats = {};
        const count = parseInt(document.getElementById('team-count').value) || 0;
        let teams = [];
        if(count > 0) {
            for(let i=1; i<=count; i++) teams.push(`Team${i}`);
        } else {
            // Fallback
            state.matches.forEach(m => {
                if (m.type === 'match') {
                    if(!teams.includes(m.t1)) teams.push(m.t1);
                    if(!teams.includes(m.t2)) teams.push(m.t2);
                }
            });
        }

        teams.forEach(t => {
            stats[t] = { name: t, wins: 0, points: 0, diff: 0, games: 0 };
        });

        // Calc
        state.matches.forEach(m => {
            if(m.type === 'match' && m.s1 !== null && m.s2 !== null) {
                const p1 = stats[m.t1];
                const p2 = stats[m.t2];
                if(p1 && p2) {
                    p1.games++; p2.games++;
                    p1.points += m.s1; p2.points += m.s2;
                    p1.diff += (m.s1 - m.s2);
                    p2.diff += (m.s2 - m.s1);

                    if(m.s1 > m.s2) p1.wins++;
                    else if(m.s2 > m.s1) p2.wins++;
                }
            }
        });

        // Sort: å‹ã¡æ•° > å¾—å¤±ç‚¹å·® > ç·å¾—ç‚¹
        const sorted = Object.values(stats).sort((a, b) => {
            if(b.wins !== a.wins) return b.wins - a.wins;
            if(b.diff !== a.diff) return b.diff - a.diff;
            return b.points - a.points;
        });

        sorted.forEach((t, idx) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${idx + 1}</td>
                <td style="font-weight:bold;">${getTeamName(t.name)}</td>
                <td>${t.wins}</td>
                <td>${t.diff > 0 ? '+'+t.diff : t.diff}</td>
                <td>${t.points}</td>
            `;
            tbody.appendChild(tr);
        });
    };

    // --- TAB 4: Rules ---
    window.insertRule = (type) => {
        const ta = document.getElementById('rule-text');
        let text = "";
        
        if(type === 'strict') {
            text = "ã€å³å®ˆäº‹é …ã€‘\nãƒ»å¯©åˆ¤ã¸ã®ã‚¯ãƒ¬ãƒ¼ãƒ ã¯å³é€€å ´å‡¦åˆ†ã¨ã—ã¾ã™ã€‚\nãƒ»æ–½è¨­å†…ã§ã®é£²é…’ã€å–«ç…™ã¯ç¦æ­¢ã§ã™ã€‚\nãƒ»è£…é£¾å“ï¼ˆãƒ”ã‚¢ã‚¹ç­‰ï¼‰ã¯å¤–ã—ã¦ãã ã•ã„ã€‚";
        } else if(type === 'volley') {
            text = "ã€ãƒãƒ¬ãƒ¼ãƒœãƒ¼ãƒ«ç‹¬è‡ªãƒ«ãƒ¼ãƒ«ã€‘\nãƒ»äºˆé¸1å‘¨ç›®: å¥³æ€§2ç‚¹/ãƒ¬ãƒ™ãƒ«4ä»¥ä¸‹å¾—ç‚¹2å€\nãƒ»äºˆé¸2å‘¨ç›®: ã‚»ãƒƒã‚¿ãƒ¼å›ºå®šãªã—/ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³å¿…é ˆ\nãƒ»ãƒãƒƒãƒˆã‚¿ãƒƒãƒã¯å³æ ¼ã«å–ã‚Šã¾ã™ã€‚";
        } else if(type === '3x3') {
            text = "ã€3x3 ç‹¬è‡ªãƒ«ãƒ¼ãƒ«ã€‘\nãƒ»è©¦åˆæ™‚é–“: 7åˆ†æµã— or 21ç‚¹å…ˆå–\nãƒ»çµŒé¨“è€…ãƒãƒ¼ãƒ ã®å¥³æ€§å¾—ç‚¹ã¯+1ç‚¹ï¼ˆã‚·ãƒ¥ãƒ¼ãƒˆ3ç‚¹/4ç‚¹ï¼‰\nãƒ»ãƒãƒ¼ãƒ ãƒ•ã‚¡ãƒ¼ãƒ«5å›ç›®ã‹ã‚‰ãƒ•ãƒªãƒ¼ã‚¹ãƒ­ãƒ¼ã€‚\nãƒ»æ”»å®ˆäº¤ä»£ã¯ãƒœãƒ¼ãƒ«ãƒã‚§ãƒƒã‚¯å¾Œå³ã‚¹ã‚¿ãƒ¼ãƒˆã€‚";
        }

        const currentPos = ta.selectionStart;
        const val = ta.value;
        ta.value = val.slice(0, currentPos) + text + val.slice(currentPos);
        saveRules();
    };

    window.saveRules = () => {
        state.rules = document.getElementById('rule-text').value;
        saveData();
    };

</script>

</body>
</html>
